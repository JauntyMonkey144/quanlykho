{% load crispy_forms_tags %}
{% load static %}

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-export-subtle text-dark fw-bold border-bottom border-export">
        I. THÔNG TIN XUẤT KHO
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6 position-relative">
                {{ form.ma_nhan_vien|as_crispy_field }}
                <div id="suggestion-box" class="list-group position-absolute w-100 shadow-lg" style="z-index: 9999; display: none;"></div>
                <small class="text-muted fst-italic ms-1"><i class="bi bi-keyboard"></i> Gõ mã NV hoặc tên để tìm kiếm.</small>
            </div>
        </div>

        <div class="row bg-light p-3 rounded mx-0 mb-3">
            <div class="col-md-3">{{ form.nguoi_de_xuat|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.email|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.chuc_vu|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.phong_ban|as_crispy_field }}</div>
        </div>

        <div class="row mt-2">
            <div class="col-md-12">{{ form.ly_do|as_crispy_field }}</div>
            <div class="col-md-12">{{ form.ghi_chu|as_crispy_field }}</div>
        </div>
    </div>
</div>

<div class="mb-4">
    <button type="button" class="btn btn-outline-export text-dark btn-sm" data-bs-toggle="collapse" data-bs-target="#extraTools">
        <i class="bi bi-paperclip"></i> Đính kèm Ảnh / Import Excel
    </button>
    <div class="collapse mt-2" id="extraTools">
        <div class="card card-body bg-light border-0 shadow-sm">
            <div class="row">
                <div class="col-md-6 border-end">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fw-bold text-dark mb-0">Import Excel</label>
                        <a href="{% static 'excel/template_export.xlsx' %}" class="badge bg-export text-white text-decoration-none" download>
                            <i class="bi bi-download"></i> Tải mẫu
                        </a>
                    </div>
                    
                    <div id="excel-drop-zone" class="excel-upload-area">
                        <div class="upload-content">
                            <i class="bi bi-file-earmark-spreadsheet-fill text-export display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả file Excel vào đây</p>
                            <button type="button" id="btn-select-excel" class="btn btn-export btn-sm rounded-pill px-4">Chọn file</button>
                            <div id="excel-file-name" class="mt-3 text-dark fw-bold fst-italic small"></div>
                        </div>
                        <div class="d-none">{{ form.excel_file }}</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="fw-bold text-dark mb-2">Ảnh minh họa / Hiện trạng</label>
                    <div id="drop-zone" class="upload-area" style="border-color: var(--export-color);">
                        <div class="upload-content">
                            <i class="bi bi-cloud-arrow-up-fill text-export display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả ảnh vào đây</p>
                            <button type="button" id="btn-select" class="btn btn-export btn-sm rounded-pill px-4">Chọn ảnh</button>
                        </div>
                        <div class="d-none">{{ form.photos }}</div>
                    </div>
                    <div id="new-images-preview" class="row g-2 mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-export-subtle d-flex justify-content-between align-items-center border-bottom border-export">
        <span class="fw-bold text-dark">II. DANH SÁCH XUẤT KHO</span>
        <button type="button" id="add-row" class="btn btn-light btn-sm fw-bold text-export border-export shadow-sm">
            <i class="bi bi-plus-circle-fill"></i> Thêm dòng
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 align-middle text-nowrap" id="items-table">
                <thead class="bg-light text-center">
                    <tr>
                        <th width="5%">STT</th>
                        <th width="45%">Tên tài sản / Thiết bị <span class="text-danger">*</span></th>
                        <th width="10%">ĐVT</th>
                        <th width="10%">SL</th>
                        <th width="25%">Ghi chú</th>
                        <th width="5%"><i class="bi bi-trash3"></i></th>
                    </tr>
                </thead>
                <tbody id="form-body">
                    {{ item_formset.management_form }}
                    {% for form in item_formset %}
                    <tr class="item-row">
                        <td class="text-center fw-bold row-index">{{ forloop.counter }}</td>
                        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                        
                        <td>{{ form.ten_hang_hoa|as_crispy_field }}</td>
                        <td>{{ form.don_vi_tinh|as_crispy_field }}</td>
                        <td>{{ form.so_luong|as_crispy_field }}</td>
                        <td>{{ form.ghi_chu|as_crispy_field }}</td>
                        
                        <td class="d-none">{{ form.DELETE }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-danger btn-sm delete-row border-0">
                                <i class="bi bi-x-circle-fill fs-5"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<table style="display: none">
    <tbody id="empty-form-template">
        <tr class="item-row">
            <td class="text-center fw-bold row-index">#</td>
            <td>{{ item_formset.empty_form.ten_hang_hoa|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.don_vi_tinh|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.so_luong|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.ghi_chu|as_crispy_field }}</td>
            <td class="d-none">{{ item_formset.empty_form.DELETE }}</td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm delete-row border-0">
                    <i class="bi bi-x-circle-fill fs-5"></i>
                </button>
            </td>
        </tr>
    </tbody>
</table>

<style>
    /* Bỏ margin thừa của Crispy form trong bảng */
    #items-table .form-group { margin-bottom: 0; } 
    #items-table label { display: none; }
    
    /* Input trong bảng trông giống dòng kẻ */
    #items-table input { 
        border: none; 
        border-bottom: 1px solid #dee2e6; 
        border-radius: 0; 
        padding: 0.5rem; 
        background: transparent; 
    }
    #items-table input:focus { 
        box-shadow: none; 
        border-bottom: 2px solid var(--export-color); 
        background-color: #fffbf0; 
    }
    
    /* Vùng Upload */
    .upload-area, .excel-upload-area { 
        border: 2px dashed var(--export-color); 
        border-radius: 12px; 
        background-color: #fff; 
        padding: 2rem; 
        text-align: center; 
        cursor: pointer; 
        transition: 0.3s; 
    }
    .upload-area:hover, .excel-upload-area:hover { 
        border-color: var(--export-hover); 
        background-color: #fffbf0; 
    }
    .upload-area.drag-over, .excel-upload-area.drag-over-excel { 
        border-style: solid; 
        border-color: var(--export-hover); 
        background-color: #fff3cd; 
        transform: scale(1.02); 
    }
    .upload-content { pointer-events: auto; }
</style>