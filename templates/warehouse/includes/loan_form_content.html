{% load crispy_forms_tags %}
{% load static %}

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-primary bg-opacity-10 text-primary fw-bold">
        I. THÔNG TIN NGƯỜI MƯỢN
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6 position-relative">
                {{ form.ma_nhan_vien|as_crispy_field }}
                
                <div id="suggestion-box" class="list-group position-absolute w-100 shadow-lg" 
                     style="z-index: 9999; top: 85px; left: 12px; width: 96% !important; max-height: 300px; overflow-y: auto; display: none;">
                </div>
                
                <small class="text-muted fst-italic ms-1">
                    <i class="bi bi-keyboard"></i> Gõ mã hoặc tên nhân viên để tìm kiếm tự động.
                </small>
            </div>
        </div>

        <div class="row bg-light p-3 rounded mx-0 mb-3">
            <div class="col-md-3">{{ form.nguoi_muon|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.email|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.chuc_vu|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.phong_ban|as_crispy_field }}</div>
        </div>

        <div class="row">
            <div class="col-md-12">{{ form.ly_do|as_crispy_field }}</div>
            <div class="col-md-6">
                {{ form.ngay_tra_chung|as_crispy_field }}
                <small class="text-muted fst-italic">* Chọn ngày này để tự động điền cho tất cả hàng hóa bên dưới.</small>
            </div>
            <div class="col-md-12">{{ form.ghi_chu|as_crispy_field }}</div>
        </div>
    </div>
</div>

<div class="mb-4">
    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#extraTools">
        <i class="bi bi-paperclip"></i> Đính kèm Ảnh hoặc Import Excel
    </button>
    <div class="collapse mt-2" id="extraTools">
        <div class="card card-body bg-light border-0 shadow-sm">
            <div class="row">
                <div class="col-md-6 border-end">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fw-bold text-success mb-0">
                            <i class="bi bi-file-earmark-excel"></i> Import từ Excel
                        </label>
                        <a href="{% static 'excel/template.xlsx' %}" class="badge bg-success text-decoration-none shadow-sm" download>
                            <i class="bi bi-download"></i> Tải file mẫu
                        </a>
                    </div>
                    
                    <div id="excel-drop-zone" class="excel-upload-area">
                        <div class="upload-content">
                            <i class="bi bi-file-earmark-spreadsheet-fill text-success display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả file Excel vào đây</p>
                            <button type="button" id="btn-select-excel" class="btn btn-success btn-sm rounded-pill px-4 fw-bold shadow-sm">
                                <i class="bi bi-folder2-open"></i> Chọn file Excel
                            </button>
                            
                            <div id="excel-file-name" class="mt-3"></div>
                        </div>
                        <div class="d-none">{{ form.excel_file }}</div>
                    </div>
                    <i class="bi bi-info-circle"></i> Cột bắt buộc: <strong>Tên tài sản, Đơn vị tính, Số lượng, Ngày mượn, Ngày trả dự kiến, Tình trạng, Ghi chú</strong>
                </div>

                <div class="col-md-6">
                    <label class="fw-bold text-info mb-2"><i class="bi bi-images"></i> Ảnh hiện trạng</label>
                    <div id="drop-zone" class="upload-area">
                        <div class="upload-content">
                            <i class="bi bi-cloud-arrow-up-fill text-primary display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả hình ảnh vào đây</p>
                            <button type="button" id="btn-select" class="btn btn-primary btn-sm rounded-pill px-4 fw-bold shadow-sm">
                                <i class="bi bi-folder2-open"></i> Chọn từ thiết bị
                            </button>
                            <div class="small text-muted mt-2 fst-italic">(Hoặc click vào khung này)</div>
                        </div>
                        <div class="d-none">{{ form.photos }}</div>
                    </div>

                    <div id="new-images-preview" class="row g-2 mt-3"></div>

                    {% if loan and loan.images.all %}
                    <div class="mt-3 p-2 bg-white rounded border">
                        <div class="small text-muted fw-bold mb-2"><i class="bi bi-hdd"></i> Ảnh đã lưu (Tích vào để xóa):</div>
                        <div class="d-flex flex-wrap gap-2">
                            {% for img in loan.images.all %}
                            <div class="position-relative" style="width: 80px; height: 80px;">
                                <img src="{{ img.image.url }}" class="w-100 h-100 object-fit-cover rounded border">
                                <div class="form-check position-absolute top-0 end-0 m-1">
                                    <input class="form-check-input border-danger shadow-sm" type="checkbox" name="delete_ids" value="{{ img.id }}" title="Xóa ảnh này">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span class="fw-bold text-uppercase">II. DANH SÁCH VẬT TƯ</span>
        <button type="button" id="add-row" class="btn btn-light btn-sm fw-bold text-primary shadow-sm">
            <i class="bi bi-plus-circle-fill"></i> Thêm dòng
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 table-hover align-middle text-nowrap" id="items-table">
                <thead class="bg-light text-center">
                    <tr>
                        <th width="5%">STT</th>
                        <th width="25%">Tên tài sản <span class="text-danger">*</span></th>
                        <th width="10%">ĐVT</th>
                        <th width="10%">SL</th>
                        <th width="12%">Ngày mượn</th>
                        <th width="12%">Ngày trả dự kiến</th>
                        <th width="15%">Tình trạng</th>
                        <th width="15%">Ghi chú</th>
                        <th width="5%"><i class="bi bi-trash3"></i></th>
                    </tr>
                </thead>
                <tbody id="form-body">
                    {{ item_formset.management_form }}
                    {% for form in item_formset %}
                        <tr class="item-row">
                            <td class="text-center fw-bold row-index">{{ forloop.counter }}</td>
                            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            
                            <td>{{ form.ten_tai_san|as_crispy_field }}</td>
                            <td>{{ form.don_vi_tinh|as_crispy_field }}</td>
                            <td>{{ form.so_luong|as_crispy_field }}</td>
                            <td>{{ form.ngay_muon|as_crispy_field }}</td>
                            <td>{{ form.ngay_tra_du_kien|as_crispy_field }}</td>
                            <td>
                                {{ form.tinh_trang|as_crispy_field }}
                                <div class="mt-1 condition-other-wrapper {% if form.tinh_trang.value != 'khac' %}d-none{% endif %}">
                                    {{ form.tinh_trang_khac|as_crispy_field }}
                                </div>
                            </td>
                            <td>{{ form.ghi_chu|as_crispy_field }}</td>
                            <td class="d-none">{{ form.DELETE }}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm delete-row border-0">
                                    <i class="bi bi-x-circle-fill fs-5"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<table style="display: none">
    <tbody id="empty-form-template">
        <tr class="item-row">
            <td class="text-center fw-bold row-index">#</td>
            <td>{{ item_formset.empty_form.ten_tai_san|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.don_vi_tinh|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.so_luong|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.ngay_muon|as_crispy_field }}</td>
            <td>{{ item_formset.empty_form.ngay_tra_du_kien|as_crispy_field }}</td>
            <td>
                {{ item_formset.empty_form.tinh_trang|as_crispy_field }}
                <div class="mt-1 condition-other-wrapper d-none">
                    {{ item_formset.empty_form.tinh_trang_khac|as_crispy_field }}
                </div>
            </td>
            <td>{{ item_formset.empty_form.ghi_chu|as_crispy_field }}</td>
            <td class="d-none">{{ item_formset.empty_form.DELETE }}</td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm delete-row border-0">
                    <i class="bi bi-x-circle-fill fs-5"></i>
                </button>
            </td>
        </tr>
    </tbody>
</table>

<style>
    #items-table .form-group { margin-bottom: 0; }
    #items-table .form-group label { display: none; }
    #items-table input, #items-table select { border: none; border-bottom: 1px solid #dee2e6; border-radius: 0; padding: 0.5rem; background: transparent; }
    #items-table input:focus, #items-table select:focus { box-shadow: none; border-bottom: 2px solid #0d6efd; background-color: #f8f9fa; }
    
    /* Upload CSS */
    .upload-area { border: 2px dashed #cbd5e1; border-radius: 12px; background-color: #fff; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; }
    .upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
    .upload-area.drag-over { border-style: solid; border-color: #10b981; background-color: #ecfdf5; transform: scale(1.02); }
    
    .excel-upload-area { border: 2px dashed #a3cfbb; border-radius: 12px; background-color: #fff; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; }
    .excel-upload-area:hover { border-color: #198754; background-color: #f8fffb; }
    .excel-upload-area.drag-over-excel { border-style: solid; border-color: #198754; background-color: #d1e7dd; transform: scale(1.02); }
    
    .upload-content { pointer-events: auto; }
</style>
