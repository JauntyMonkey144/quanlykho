{% load crispy_forms_tags %}
{% load static %}

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-success bg-opacity-10 text-success fw-bold">I. THÔNG TIN ĐỀ XUẤT</div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6 position-relative">
                {{ form.ma_nhan_vien|as_crispy_field }}
                <div id="suggestion-box" class="list-group position-absolute w-100 shadow-lg" style="z-index: 9999; display: none;"></div>
                <small class="text-muted fst-italic ms-1"><i class="bi bi-keyboard"></i> Gõ mã để tìm kiếm.</small>
            </div>
        </div>
        <div class="row bg-light p-3 rounded mx-0 mb-3">
            <div class="col-md-3">{{ form.nguoi_de_xuat|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.email|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.chuc_vu|as_crispy_field }}</div>
            <div class="col-md-3">{{ form.phong_ban|as_crispy_field }}</div>
        </div>
        <div class="row">
            <div class="col-md-8">{{ form.ly_do|as_crispy_field }}</div>
            <div class="col-md-12">{{ form.nha_cung_cap|as_crispy_field }}</div>
            <div class="col-md-12">{{ form.ghi_chu|as_crispy_field }}</div>
        </div>
    </div>
</div>

<div class="mb-4">
    <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="collapse" data-bs-target="#extraTools">
        <i class="bi bi-paperclip"></i> Đính kèm Ảnh / Excel
    </button>
    <div class="collapse mt-2" id="extraTools">
        <div class="card card-body bg-light border-0 shadow-sm">
            <div class="row">
                <div class="col-md-6 border-end">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fw-bold text-success mb-0">Import Excel</label>
                        <a href="{% static 'excel/template.xlsx' %}" class="badge bg-success text-decoration-none" download>Tải mẫu</a>
                    </div>
                    <div id="excel-drop-zone" class="excel-upload-area">
                        <div class="upload-content">
                            <i class="bi bi-file-earmark-spreadsheet-fill text-success display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả file Excel</p>
                            <button type="button" id="btn-select-excel" class="btn btn-success btn-sm rounded-pill px-4 fw-bold">Chọn file</button>
                            <div id="excel-file-name" class="mt-3 text-success fw-bold fst-italic small"></div>
                        </div>
                        <div class="d-none">{{ form.excel_file }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold text-success mb-2">Ảnh minh họa</label>
                    <div id="drop-zone" class="upload-area" style="border-color: #a3cfbb;">
                        <div class="upload-content">
                            <i class="bi bi-cloud-arrow-up-fill text-success display-4"></i>
                            <p class="mt-2 mb-3 text-muted fw-bold">Kéo thả ảnh</p>
                            <button type="button" id="btn-select" class="btn btn-success btn-sm rounded-pill px-4 fw-bold">Chọn ảnh</button>
                        </div>
                        <div class="d-none">{{ form.photos }}</div>
                    </div>
                    <div id="new-images-preview" class="row g-2 mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span class="fw-bold">II. DANH SÁCH HÀNG HÓA</span>
        <button type="button" id="add-row" class="btn btn-light btn-sm fw-bold text-success"><i class="bi bi-plus-circle-fill"></i> Thêm dòng</button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 align-middle text-nowrap" id="items-table">
                <thead class="bg-light text-center">
                    <tr>
                        <th width="5%">STT</th>
                        <th width="45%">Tên hàng hóa, quy cách</th>
                        <th width="10%">Đơn vị tính</th>
                        <th width="10%">Số lượng</th>
                        <th width="25%">Ghi chú</th>
                        <th width="5%"><i class="bi bi-trash3"></i></th>
                    </tr>
                </thead>
                <tbody id="form-body">
                    {{ item_formset.management_form }}
                    {% for form in item_formset %}
                    <tr class="item-row">
                        <td class="text-center fw-bold row-index">{{ forloop.counter }}</td>
                        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                        <td>{{ form.ten_hang_hoa|as_crispy_field }}</td>
                        <td>{{ form.don_vi_tinh|as_crispy_field }}</td>
                        <td>{{ form.so_luong|as_crispy_field }}</td>
                        <td>{{ form.ghi_chu|as_crispy_field }}</td>
                        <td class="d-none">{{ form.DELETE }}</td>
                        <td class="text-center"><button type="button" class="btn btn-outline-danger btn-sm delete-row border-0"><i class="bi bi-x-circle-fill fs-5"></i></button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<table style="display: none"><tbody id="empty-form-template">
    <tr class="item-row">
        <td class="text-center fw-bold row-index">#</td>
        <td>{{ item_formset.empty_form.ten_hang_hoa|as_crispy_field }}</td>
        <td>{{ item_formset.empty_form.don_vi_tinh|as_crispy_field }}</td>
        <td>{{ item_formset.empty_form.so_luong|as_crispy_field }}</td>
        <td>{{ item_formset.empty_form.ghi_chu|as_crispy_field }}</td>
        <td class="d-none">{{ item_formset.empty_form.DELETE }}</td>
        <td class="text-center"><button type="button" class="btn btn-outline-danger btn-sm delete-row border-0"><i class="bi bi-x-circle-fill fs-5"></i></button></td>
    </tr>
</tbody></table>

<style>
    #items-table .form-group { margin-bottom: 0; } #items-table label { display: none; }
    #items-table input { border: none; border-bottom: 1px solid #dee2e6; border-radius: 0; padding: 0.5rem; background: transparent; }
    #items-table input:focus { box-shadow: none; border-bottom: 2px solid #198754; background-color: #f8fffb; }
    /* Upload CSS dùng chung */
    .upload-area { border: 2px dashed #a3cfbb; border-radius: 12px; background-color: #fff; padding: 2rem; text-align: center; cursor: pointer; transition: 0.3s; }
    .upload-area:hover { border-color: #198754; background-color: #f8fffb; }
    .upload-area.drag-over { border-style: solid; border-color: #198754; background-color: #d1e7dd; transform: scale(1.02); }
    .excel-upload-area { border: 2px dashed #a3cfbb; border-radius: 12px; background-color: #fff; padding: 2rem; text-align: center; cursor: pointer; transition: 0.3s; }
    .excel-upload-area:hover { border-color: #198754; background-color: #f8fffb; }
    .excel-upload-area.drag-over-excel { border-style: solid; border-color: #198754; background-color: #d1e7dd; transform: scale(1.02); }
    .upload-content { pointer-events: auto; }
</style>