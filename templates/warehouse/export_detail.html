{% extends "base.html" %}
{% load auth_extras %}
{% block title %}Chi tiết Phiếu Xuất #{{ slip.id }}{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="mb-3"><a href="{% url 'export_list' %}" class="text-decoration-none text-muted"><i class="bi bi-arrow-left"></i> Quay lại</a></div>

        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <h5 class="fw-bold text-{{ slip.status_color }} mb-3">TRẠNG THÁI: {{ slip.get_status_display|upper }}</h5>
                <div class="d-flex gap-2 flex-wrap">
                    
                    {% if slip.status == 'draft' or slip.status == 'rejected' %}
                        {% if user == slip.created_by or user.is_superuser %}
                            <a href="{% url 'export_action' slip.id 'send' %}" class="btn btn-warning fw-bold"><i class="bi bi-send"></i> Gửi duyệt</a>
                            <a href="{% url 'edit_export' slip.id %}" class="btn btn-outline-dark fw-bold"><i class="bi bi-pencil"></i> Sửa phiếu</a>
                        {% endif %}
                    {% endif %}

                    {% if slip.status == 'dept_pending' %}
                        {% if request.user|has_group:"TruongPhong" or user.is_superuser %}
                            <a href="{% url 'export_action' slip.id 'dept_approve' %}" class="btn btn-info text-white fw-bold">Trưởng Phòng Duyệt</a>
                            <a href="{% url 'export_action' slip.id 'reject' %}" class="btn btn-outline-danger">Từ chối</a>
                        {% else %} <span class="badge bg-secondary p-2">Chờ trưởng phòng duyệt</span> {% endif %}
                    {% endif %}

                    {% if slip.status == 'warehouse_pending' %}
                        {% if request.user|has_group:"ThuKho" or user.is_superuser %}
                            <a href="{% url 'export_action' slip.id 'warehouse_approve' %}" class="btn btn-warning fw-bold">Thủ kho Duyệt (Đủ hàng)</a>
                            <a href="{% url 'export_action' slip.id 'reject' %}" class="btn btn-outline-danger">Từ chối</a>
                        {% else %} <span class="badge bg-secondary p-2">Chờ Thủ kho kiểm tra</span> {% endif %}
                    {% endif %}

                    {% if slip.status == 'director_pending' %}
                        {% if request.user|has_group:"GiamDoc" or user.is_superuser %}
                            <a href="{% url 'export_action' slip.id 'director_approve' %}" class="btn btn-primary fw-bold">Giám đốc Duyệt</a>
                            <a href="{% url 'export_action' slip.id 'reject' %}" class="btn btn-outline-danger">Từ chối</a>
                        {% else %} <span class="badge bg-secondary p-2">Chờ giám đốc duyệt</span> {% endif %}
                    {% endif %}

                    <a href="{% url 'export_export_pdf' slip.id %}" class="btn btn-dark ms-auto" target="_blank"><i class="bi bi-printer"></i> PDF</a>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning bg-opacity-75 fw-bold">I. THÔNG TIN XUẤT KHO</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3"><label class="text-muted small">Người đề xuất</label><div class="fw-bold">{{ slip.nguoi_de_xuat }}</div></div>
                    <div class="col-md-3"><label class="text-muted small">Phòng ban</label><div>{{ slip.phong_ban }}</div></div>
                    <div class="col-md-6"><label class="text-muted small">Lý do</label><div>{{ slip.ly_do }}</div></div>
                    {% if slip.ghi_chu %}<div class="col-md-12"><label class="text-muted small">Ghi chú</label><div>{{ slip.ghi_chu }}</div></div>{% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-warning bg-opacity-75 fw-bold">II. DANH SÁCH HÀNG HÓA</div>
            <div class="card-body p-0">
                <table class="table table-bordered mb-0 align-middle text-center">
                    <thead class="bg-light"><tr><th>STT</th><th class="text-start">Tên tài sản</th><th>ĐVT</th><th>SL</th><th class="text-start">Ghi chú</th></tr></thead>
                    <tbody>
                        {% for item in slip.items.all %}
                        <tr>
                            <td>{{ forloop.counter }}</td><td class="text-start">{{ item.ten_hang_hoa }}</td><td>{{ item.don_vi_tinh }}</td><td class="fw-bold">{{ item.so_luong }}</td><td class="text-start">{{ item.ghi_chu|default:"" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-4 border-0 shadow-sm">
            <div class="card-header bg-light fw-bold">NHẬT KÝ XỬ LÝ</div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for log in slip.history.all|dictsort:"timestamp" %}
                    <li class="pb-3 border-bottom mb-3">
                        <div class="d-flex justify-content-between"><strong class="text-warning text-dark">{{ log.action }}</strong><span class="text-muted small">{{ log.timestamp|date:"H:i d/m/Y" }}</span></div>
                        <small class="text-muted">Bởi: {{ log.user.username }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}